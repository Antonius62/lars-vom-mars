<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lars vom Mars - Hörbuch</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: url('./mars_background.png') center/cover fixed;
            color: white;
            font-family: Arial, sans-serif;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }
        
        /* Haupt-Container */
        .main-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            padding: 20px;
        }
        
        /* Header-Bereich */
        .header {
            height: 10%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
        }
        
        .back-button {
            background: rgba(255, 255, 255, 0.3);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            color: white;
        }
        
        .book-title {
            font-size: 24px;
            color: white;
            text-align: center;
            flex-grow: 1;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);
        }
        
        /* Inhaltsbereich */
        .content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px 0;
        }
        
        .book-cover {
            width: 200px;
            height: 200px;
            background: rgba(255, 255, 0, 0.3);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            box-shadow: 0 0 20px rgba(255, 255, 0, 0.2);
        }
        
        .book-cover img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 10px;
        }
        
        .book-info {
            width: 80%;
            max-width: 500px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .book-description {
            font-size: 16px;
            margin-bottom: 20px;
            color: rgba(255, 255, 255, 0.9);
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(5px);
            padding: 15px;
            border-radius: 10px;
        }
        
        /* Kapitel-Liste */
        .chapter-list {
            width: 80%;
            max-width: 500px;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 20px;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
            border-radius: 10px;
            padding: 10px;
        }
        
        .chapter-item {
            padding: 10px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .chapter-item:hover, .chapter-item.active {
            background: rgba(255, 255, 0, 0.2);
        }
        
        /* Player-Steuerung */
        .player-controls {
            width: 80%;
            max-width: 500px;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(5px);
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .time-display {
            display: flex;
            justify-content: space-between;
            color: white;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .timeline {
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 15px;
            cursor: pointer;
            position: relative;
        }
        
        .timeline-progress {
            height: 100%;
            width: 0;
            background: rgba(255, 255, 0, 0.8);
            border-radius: 4px;
            transition: width 0.1s linear;
        }
        
        .control-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
        }
        
        .control-btn {
            background: none;
            border: none;
            color: white;
            font-size: 22px;
            cursor: pointer;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .control-btn.play-pause {
            font-size: 36px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
        }
        
        /* Responsive Anpassungen */
        @media (max-width: 768px) {
            .book-cover {
                width: 150px;
                height: 150px;
            }
            
            .book-description {
                font-size: 14px;
            }
            
            .control-buttons {
                gap: 20px;
            }
            
            .control-btn {
                font-size: 18px;
            }
            
            .control-btn.play-pause {
                font-size: 30px;
            }
        }
        
        /* Loading-Indikator */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header">
            <button class="back-button" onclick="goBack()">←</button>
            <h1 class="book-title" id="book-title">Hörbuch wird geladen...</h1>
            <div style="width: 40px;"></div> <!-- Platzhalter für Symmetrie -->
        </div>
        
        <div class="content">
            <div class="book-cover" id="book-cover">
                <!-- Bild wird per JavaScript eingefügt -->
            </div>
            
            <div class="book-info">
                <p class="book-description" id="book-description">Beschreibung wird geladen...</p>
            </div>
            
            <div class="chapter-list" id="chapter-list">
                <!-- Kapitel werden per JavaScript eingefügt -->
            </div>
            
            <div class="player-controls">
                <div class="time-display">
                    <span id="current-time">0:00</span>
                    <span id="total-time">0:00</span>
                </div>
                <div class="timeline" id="timeline">
                    <div class="timeline-progress" id="progress"></div>
                </div>
                <div class="control-buttons">
                    <button class="control-btn rewind" onclick="rewindAudio()" title="10 Sekunden zurück">⏪</button>
                    <button class="control-btn play-pause" id="play-pause-btn" onclick="togglePlayPause()" title="Abspielen/Pause">▶</button>
                    <button class="control-btn forward" onclick="forwardAudio()" title="10 Sekunden vor">⏩</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>
    
    <script>
        // Globale Variablen
        let audioPlayer = new Audio();
        let activeChapter = null;
        let audiobook = null;
        let isPlaying = false;
        let updateInterval;
        
        // Audio-Player initialisieren
        function initAudioPlayer() {
            // Wiedergabe-Status überwachen
            audioPlayer.addEventListener('play', () => {
                document.getElementById('play-pause-btn').innerHTML = '⏸';
                isPlaying = true;
                startProgressUpdate();
            });
            
            audioPlayer.addEventListener('pause', () => {
                document.getElementById('play-pause-btn').innerHTML = '▶';
                isPlaying = false;
                stopProgressUpdate();
            });
            
            audioPlayer.addEventListener('ended', () => {
                playNextChapter();
            });
            
            // Timeline-Klick ermöglichen
            document.getElementById('timeline').addEventListener('click', (e) => {
                if (!audioPlayer.src) return;
                
                const timeline = document.getElementById('timeline');
                const rect = timeline.getBoundingClientRect();
                const percentage = (e.clientX - rect.left) / rect.width;
                
                audioPlayer.currentTime = percentage * audioPlayer.duration;
                updateProgress();
            });
        }
        
        // Starte Aktualisierung des Fortschrittsbalkens
        function startProgressUpdate() {
            updateInterval = setInterval(updateProgress, 100);
        }
        
        // Stoppe Aktualisierung des Fortschrittsbalkens
        function stopProgressUpdate() {
            clearInterval(updateInterval);
        }
        
        // Aktualisiere Fortschrittsbalken und Zeitanzeige
        function updateProgress() {
            if (!audioPlayer.duration) return;
            
            const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
            document.getElementById('progress').style.width = `${progress}%`;
            
            document.getElementById('current-time').textContent = formatTime(audioPlayer.currentTime);
            document.getElementById('total-time').textContent = formatTime(audioPlayer.duration);
        }
        
        // Formatiere Zeit als mm:ss
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }
        
        // Abspielen/Pause umschalten
        function togglePlayPause() {
            if (!audioPlayer.src) return;
            
            if (isPlaying) {
                audioPlayer.pause();
            } else {
                audioPlayer.play().catch(error => {
                    console.error('Fehler beim Abspielen:', error);
                    alert('Fehler beim Abspielen der Audio-Datei');
                });
            }
        }
        
        // 10 Sekunden zurückspulen
        function rewindAudio() {
            if (!audioPlayer.src) return;
            audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 10);
            updateProgress();
        }
        
        // 10 Sekunden vorspulen
        function forwardAudio() {
            if (!audioPlayer.src) return;
            audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + 10);
            updateProgress();
        }
        
        // Kapitel abspielen
        function playChapter(chapterId) {
            if (!audiobook || !audiobook.chapters) return;
            
            // Finde das Kapitel
            const chapter = audiobook.chapters.find(ch => ch.id === chapterId);
            if (!chapter) return;
            
            // Aktives Kapitel markieren
            if (activeChapter) {
                document.querySelector(`.chapter-item[data-id="${activeChapter}"]`).classList.remove('active');
            }
            document.querySelector(`.chapter-item[data-id="${chapterId}"]`).classList.add('active');
            activeChapter = chapterId;
            
            // Audio-Datei laden und abspielen
            audioPlayer.src = chapter.audioUrl;
            audioPlayer.currentTime = 0;
            audioPlayer.play().catch(error => {
                console.error('Fehler beim Abspielen:', error);
                alert('Fehler beim Abspielen der Audio-Datei');
            });
        }
        
        // Nächstes Kapitel abspielen
        function playNextChapter() {
            if (!audiobook || !audiobook.chapters || !activeChapter) return;
            
            const currentIndex = audiobook.chapters.findIndex(ch => ch.id === activeChapter);
            if (currentIndex < audiobook.chapters.length - 1) {
                playChapter(audiobook.chapters[currentIndex + 1].id);
            } else {
                // Ende des Hörbuchs erreicht
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
                updateProgress();
            }
        }
        
        // Hörbuch-Daten aus IndexedDB laden
        function loadAudiobookData() {
            showLoading();
            
            // Hörbuch-ID aus URL-Parameter extrahieren
            const urlParams = new URLSearchParams(window.location.search);
            const audiobookId = urlParams.get('id');
            
            if (!audiobookId) {
                hideLoading();
                alert('Keine Hörbuch-ID gefunden');
                goBack();
                return;
            }
            
            // IndexedDB öffnen
            const request = indexedDB.open('LarsVomMarsDB', 1);
            
            request.onupgradeneeded = function(event) {
                const db = event.target.result;
                if (!db.objectStoreNames.contains('audiobooks')) {
                    db.createObjectStore('audiobooks', { keyPath: 'id' });
                }
            };
            
            request.onerror = function(event) {
                hideLoading();
                console.error('IndexedDB-Fehler:', event.target.error);
                alert('Fehler beim Zugriff auf die Datenbank');
                goBack();
            };
            
            request.onsuccess = function(event) {
                const db = event.target.result;
                if (!db.objectStoreNames.contains('audiobooks')) {
                    hideLoading();
                    alert('Keine Hörbücher-Datenbank gefunden');
                    goBack();
                    return;
                }
                
                const transaction = db.transaction(['audiobooks'], 'readonly');
                const store = transaction.objectStore('audiobooks');
                const getRequest = store.get(audiobookId);
                
                getRequest.onsuccess = function(event) {
                    audiobook = event.target.result;
                    
                    if (!audiobook) {
                        hideLoading();
                        alert('Hörbuch nicht gefunden');
                        goBack();
                        return;
                    }
                    
                    displayAudiobookInfo();
                    hideLoading();
                };
                
                getRequest.onerror = function(event) {
                    hideLoading();
                    console.error('Fehler beim Laden des Hörbuchs:', event.target.error);
                    alert('Fehler beim Laden des Hörbuchs');
                    goBack();
                };
            };
        }
        
        // Hörbuch-Informationen anzeigen
        function displayAudiobookInfo() {
            if (!audiobook) return;
            
            // Titel und Beschreibung
            document.getElementById('book-title').textContent = audiobook.title;
            document.getElementById('book-description').textContent = audiobook.description;
            
            // Cover-Bild
            const coverElement = document.getElementById('book-cover');
            if (audiobook.coverImage) {
                const img = document.createElement('img');
                img.src = audiobook.coverImage;
                img.alt = audiobook.title;
                coverElement.innerHTML = '';
                coverElement.appendChild(img);
            } else {
                coverElement.innerHTML = '<div style="font-size: 24px;">' + audiobook.title.charAt(0) + '</div>';
            }
            
            // Kapitel-Liste
            const chapterListElement = document.getElementById('chapter-list');
            chapterListElement.innerHTML = '';
            
            if (audiobook.chapters && audiobook.chapters.length > 0) {
                audiobook.chapters.forEach(chapter => {
                    const chapterElement = document.createElement('div');
                    chapterElement.className = 'chapter-item';
                    chapterElement.setAttribute('data-id', chapter.id);
                    chapterElement.textContent = chapter.title;
                    chapterElement.addEventListener('click', () => playChapter(chapter.id));
                    chapterListElement.appendChild(chapterElement);
                });
                
                // Automatisch erstes Kapitel abspielen
                playChapter(audiobook.chapters[0].id);
            } else {
                chapterListElement.innerHTML = '<div style="padding: 10px; text-align: center;">Keine Kapitel gefunden</div>';
            }
        }
        
        // Ladebildschirm anzeigen
        function showLoading() {
            document.getElementById('loading').style.display = 'flex';
        }
        
        // Ladebildschirm ausblenden
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
        
        // Zurück zur Hauptseite
        function goBack() {
            window.location.href = 'index.html';
        }
        
        // Initialisierung
        document.addEventListener('DOMContentLoaded', () => {
            initAudioPlayer();
            loadAudiobookData();
            
            // Offline-Unterstützung-Status anzeigen
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.ready.then(() => {
                    console.log('App ist offline verfügbar');
                });
            }
        });
    </script>
</body>
</html>
